# GitHub Copilot Instructions for shinyloadtest

This document provides guidance for working with the `shinyloadtest` package, which is used for load testing Shiny applications.

## Package Overview

`shinyloadtest` assesses the number of concurrent users Shiny applications can support. It provides facilities for:
- Recording Shiny application sessions
- Playing recorded sessions against a target server at load
- Analyzing the resulting performance metrics

## Setup Commands

### Install System Dependencies

```bash
# Install pandoc (required for building documentation and vignettes)
sudo apt-get update
sudo apt-get install -y pandoc
```

### Install R Package Dependencies

```bash
# Install from CRAN
R -e "install.packages(c('devtools', 'testthat', 'pkgdown', 'roxygen2'))"

# Install package dependencies
R -e "devtools::install_deps(dependencies = TRUE)"
```

### Install shinyloadtest from Source

```bash
# Install the package (takes ~30-60 seconds)
R CMD INSTALL --no-multiarch --with-keep.source .
```

## Build & Development Commands

### Quick Development Installation

```bash
# Update documentation and install (takes ~1-2 minutes)
make devinstall
```

### Generate Documentation

```bash
# Update function documentation
make document
# Or directly:
# R -e "devtools::document()"
```

### Build README

```bash
# Rebuild README.md from README.Rmd
make readme
```

### Build Package Site

```bash
# Build the full pkgdown site (takes ~3-5 minutes)
# CRITICAL: This will take several minutes to complete
make site
```

### R CMD Check

```bash
# Run R CMD check as CRAN (takes ~2-3 minutes)
# CRITICAL: Set timeout to at least 180 seconds
make rcmdcheck
```

## Testing Commands

### Run Full Test Suite

```bash
# Run all tests (takes ~30-60 seconds)
R -e "devtools::test()"
# Or
R CMD check --no-manual .
```

### Run Individual Test File

```bash
# Test a specific file
R -e "testthat::test_file('tests/testthat/test-url-construction.R')"
```

### Run Spelling Checks

```bash
# Check spelling
R -e "spelling::spell_check_package()"
```

### Load Package and Run Basic Tests

```bash
# Load package and verify basic functionality
R -e "library(shinyloadtest); print(packageVersion('shinyloadtest'))"
```

## Validation Requirements

**CRITICAL**: Before committing changes, always run these validation steps:

1. **Test Package Loading**:
   ```bash
   R -e "library(shinyloadtest)"
   ```

2. **Run Core Tests**:
   ```bash
   R -e "devtools::test()"
   ```

3. **Verify Documentation**:
   ```bash
   R -e "devtools::document(); devtools::check_man()"
   ```

4. **Run R CMD Check** (for significant changes):
   ```bash
   make rcmdcheck
   ```

## Repository Structure

### Key Directories

- **R/**: Main source code
  - `analysis.R` - Analysis functions for load test results
  - `plotting.R` - Visualization functions
  - `shiny-recorder.R` - Session recording functionality
  - `make_report.R` - Report generation
  - `auth.R` - Authentication handling
  - `detect.R` - Application detection utilities
  - `url.R` - URL manipulation utilities

- **tests/testthat/**: Test files
  - `test-url-construction.R` - URL building tests
  - `test-sockjs-message.R` - SockJS message handling tests
  - `test-report-gen.R` - Report generation tests
  - `test-app-detection.R` - App detection tests

- **vignettes/**: Package vignettes and documentation
  - Contains example apps for testing

- **data/**: Package data files
  - Demo load test data for examples

- **man/**: Generated documentation (do not edit manually)

- **scripts/**: Utility scripts
  - `fetch_release_urls.R` - Updates shinycannon download links
  - `test_sessions.R` - Prepares vignette test data

### Key Files

- `DESCRIPTION`: Package metadata and dependencies
- `NAMESPACE`: Package exports (auto-generated by roxygen2)
- `Makefile`: Build automation commands
- `README.Rmd`: Source for README.md (edit this, not README.md)
- `_pkgdown.yml`: Configuration for package website

## Common Development Tasks

### Adding a New Function

1. Add the function to the appropriate R file in `R/`
2. Add roxygen2 documentation comments above the function
3. Update documentation: `make document`
4. Add tests to corresponding file in `tests/testthat/`
5. Run tests: `R -e "devtools::test()"`
6. Update NEWS.md if it's a user-facing change

### Working with Load Test Data

```bash
# Update demo data (if you've changed data formats)
make demo_data
```

### Preparing Vignettes

```bash
# Prepare vignette test sessions (takes ~2-3 minutes)
make prep_vignettes
```

### Updating Shinycannon URLs

```bash
# Update shinycannon release URLs (after new shinycannon release)
make urls
```

## Testing Philosophy

- Write tests for all exported functions
- Use `testthat` for unit tests
- Test edge cases and error conditions
- Mock external dependencies when possible
- Keep tests fast and focused

## Troubleshooting

### Missing Dependencies

If you encounter errors about missing packages:

```bash
# Install all dependencies including suggested packages
R -e "devtools::install_deps(dependencies = TRUE)"
```

### Documentation Not Updating

```bash
# Force documentation rebuild
R -e "devtools::clean_vignettes(); devtools::document()"
```

### Test Failures

```bash
# Run tests with detailed output
R -e "devtools::test(reporter = 'progress')"

# Or run a specific test file
R -e "testthat::test_file('tests/testthat/test-FILENAME.R')"
```

### Build Issues

```bash
# Clean all generated files and rebuild
make clean
make devinstall
```

### Pandoc Not Found

```bash
# On Ubuntu/Debian
sudo apt-get install pandoc

# On macOS
brew install pandoc

# Or download from https://pandoc.org/installing.html
```

## Style Guidelines

- Follow the tidyverse style guide: https://style.tidyverse.org/
- Use roxygen2 for documentation
- Use `snake_case` for function and variable names
- Keep lines under 80 characters when possible
- Use descriptive variable names
- Add comments for complex logic

## Dependencies

Key package dependencies:
- **Core**: R6, rlang, cli, jsonlite
- **Data**: dplyr, vroom
- **Plotting**: ggplot2, scales, svglite
- **Web**: httpuv, websocket, curl, xml2
- **Auth**: getPass (suggested)

System requirements:
- pandoc (>= 2.2) for building documentation

## Release Process

1. Update version in DESCRIPTION
2. Update NEWS.md with changes
3. Run full R CMD check: `make rcmdcheck`
4. Update cran-comments.md
5. Build and submit to CRAN

## Additional Resources

- Package website: https://rstudio.github.io/shinyloadtest/
- GitHub repository: https://github.com/rstudio/shinyloadtest
- Issue tracker: https://github.com/rstudio/shinyloadtest/issues
- Shinycannon (load generation tool): https://github.com/rstudio/shinycannon
